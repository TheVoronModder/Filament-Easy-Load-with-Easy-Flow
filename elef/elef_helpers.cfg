# =============================================================================
# ELEF helpers (jinja2-safe)
# =============================================================================

[gcode_macro ELEF_FOLLOW_ON]
description: Keep elef_feeder synchronized with main extruder
gcode:
  SYNC_EXTRUDER_MOTION EXTRUDER=elef_feeder MOTION_QUEUE=extruder
  RESPOND PREFIX="ELEF" MSG="Follow ON."

[gcode_macro ELEF_FOLLOW_OFF]
description: Desynchronize elef_feeder
gcode:
  SYNC_EXTRUDER_MOTION EXTRUDER=elef_feeder MOTION_QUEUE=""
  RESPOND PREFIX="ELEF" MSG="Follow OFF."

[gcode_macro ELEF_STATUS]
description: Quick sensor state check
gcode:
  {% set ENTRY = printer["filament_switch_sensor elef_entry"] %}
  {% set TIP   = printer["filament_switch_sensor elef_toolhead"] %}
  RESPOND PREFIX="ELEF" MSG="Entry={{'TRIG' if ENTRY.filament_detected else 'open'}}, Tip={{'TRIG' if TIP.filament_detected else 'open'}}"

[gcode_macro ELEF_INFO]
description: Show key config values that control matching
gcode:
  {% set C = printer.configfile.settings %}
  {% set ext = C.extruder if 'extruder' in C else None %}
  {% set fed = C['extruder_stepper elef_feeder'] if 'extruder_stepper elef_feeder' in C else None %}
  RESPOND PREFIX="ELEF" MSG="Toolhead extruder: rotation_distance={{ext.rotation_distance if ext else 'n/a'}}, gear_ratio={{ext.gear_ratio if ext and 'gear_ratio' in ext else 'none'}}"
  RESPOND PREFIX="ELEF" MSG="ELEF feeder:    rotation_distance={{fed.rotation_distance if fed else 'n/a'}}, gear_ratio={{fed.gear_ratio if fed and 'gear_ratio' in fed else 'none'}}"
  RESPOND PREFIX="ELEF" MSG="If these are correct, follow-mode matches automatically."
