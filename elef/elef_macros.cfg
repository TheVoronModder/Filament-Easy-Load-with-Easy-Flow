# =============================================================================
# ELEF core macros (jinja2-safe)
# =============================================================================

[gcode_macro ELEF_AUTOLOAD]
description: Autoload: entry sensor -> fast feed until toolhead sensor; optional follow
gcode:
  # Read defaults (data-only macro)
  {% set D = printer["gcode_macro ELEF_DEFAULTS"] %}
  {% set SPEED  = (params.SPEED|default(D.variable_prefeed_speed))|float %}
  {% set CHUNK  = (params.CHUNK|default(D.variable_chunk_mm))|float %}
  {% set LIMIT  = (params.LIMIT|default(D.variable_max_mm))|float %}
  {% set FOLLOW = (params.FOLLOW|default(D.variable_follow_after))|int %}

  {% if SPEED<=0 or CHUNK<=0 or LIMIT<=0 %}
    RESPOND PREFIX="ELEF" MSG="Invalid SPEED/CHUNK/LIMIT."
    {% exit %}
  {% endif %}

  {% set ENTRY  = printer["filament_switch_sensor elef_entry"] %}
  {% set TIP    = printer["filament_switch_sensor elef_toolhead"] %}
  {% set FEEDER = "elef_feeder" %}

  # If autoload wasnâ€™t armed by the entry switch, abort (keeps logic simple/safe)
  {% if not ENTRY.filament_detected %}
    RESPOND PREFIX="ELEF" MSG="Entry sensor not active; insert filament to elef_entry first."
    {% exit %}
  {% endif %}

  SAVE_GCODE_STATE NAME=ELEF_STATE
  M83
  G92 E0

  # Fast feed using feeder only: sync feeder to extruder queue; disable main extruder motor
  SYNC_EXTRUDER_MOTION EXTRUDER={FEEDER} MOTION_QUEUE=extruder
  SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0

  RESPOND PREFIX="ELEF" MSG="Feeding at {{SPEED}} mm/s until 'elef_toolhead' triggers (limit {{LIMIT}} mm)."

  {% set moved = 0.0 %}
  {% set loops = (LIMIT / CHUNK)|round(0,'floor')|int %}
  {% for _ in range(loops) %}
    {% if TIP.filament_detected %}
      RESPOND PREFIX="ELEF" MSG="Arrival detected after ~{{'%0.1f' % moved}} mm."
      {% break %}
    {% endif %}
    G1 E{CHUNK} F{{ (SPEED*60.0)|int }}
    {% set moved = moved + CHUNK %}
  {% endfor %}

  # Restore main extruder
  SET_STEPPER_ENABLE STEPPER=extruder ENABLE=1

  # Follow behavior
  {% if TIP.filament_detected and FOLLOW==1 %}
    SYNC_EXTRUDER_MOTION EXTRUDER={FEEDER} MOTION_QUEUE=extruder
    RESPOND PREFIX="ELEF" MSG="Follow mode ON (elef_feeder synced to main extruder)."
  {% else %}
    SYNC_EXTRUDER_MOTION EXTRUDER={FEEDER} MOTION_QUEUE=""
    {% if not TIP.filament_detected %}
      RESPOND PREFIX="ELEF" MSG="Max feed {{LIMIT}} mm without arrival; feeder desynced."
    {% else %}
      RESPOND PREFIX="ELEF" MSG="Follow mode OFF by request; feeder desynced."
    {% endif %}
  {% endif %}

  G92 E0
  RESTORE_GCODE_STATE NAME=ELEF_STATE

